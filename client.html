<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Expires" content="Wed, 14 Feb 1990 00:00:01 GMT">
    <meta http-equiv="pragma" content="no-cache">
    <title>webtrc-client</title>
</head>

<body>
    <div id="app">
        <video autoplay></video>
    </div>
    <div class="right-tools">
        <button id="openCam">开启摄像头</button>
        <button id="closeCam">关闭摄像头</button>
        <button id="openRtc">開啟rtc</button>
        <button id="closeRtc">關閉rtc</button>
    </div>
</body>
<script type="module">
    let videoStream
    let pc
    let answer
    let senders = []
    let camOpen = false
    const timers = {}
    const openRtc = () => {
        pc = new RTCPeerConnection()
        pc.ontrack = function (obj) {
            console.log('rtc ontrack', obj)
        }
        pc.onaddstream = function (obj) {
            console.log('rtc onaddstream', obj)
        }
        pc.onconnectionstatechange = (event) => {
            console.log('onconnectionstatechange', pc.connectionState, event)
            if (pc.connectionState == 'disconnected') {
                answer = null
                senders = []
                clearInterval(timers.offer)
            }
        }
        pc.ondatachannel = (event) => { console.log('ondatachannel', event) }
        pc.onicecandidate = (event) => { console.log('onicecandidate', event) }
        pc.oniceconnectionstatechange = (event) => { console.log('oniceconnectionstatechange', event) }
        pc.onsignalingstatechange = (event) => {
            console.log('onsignalingstatechange', pc.signalingState, event)
            // if (openCam && pc.signalingState === 'stable') {
            //     addTracks()
            // }
        }
        if (openCam) {
            negotiate(addTracks)
        }
    }
    const closeRtc = () => {
        pc.close()
        answer = null
    }
    const addTracks = () => {
        if (camOpen && pc) {
            navigator.getUserMedia({ video: true, audio: true }, function (stream) {
                for (const track of stream.getTracks()) {
                    console.log('addTracks', track, stream)
                    // senders.push(pc.addTrack(track, stream)) // 1. track和stream同时传
                    senders.push(pc.addTrack(track)) // 2.只传track
                }
            }, function (err) { });
        }
    }
    const openCam = () => {
        navigator.getUserMedia({ video: true, audio: true }, function (stream) {
            var video = document.querySelector("video");
            video.srcObject = videoStream = stream
            camOpen = true
            // if (pc && pc.signalingState === 'stable') {
            //     addTracks()
            // }
            if (pc) {
                negotiate(addTracks)
            }
        }, function (err) { });
    }
    const closeCam = () => {
        const tracks = videoStream.getTracks()
        tracks.forEach(trk => {
            trk.enabled = false
        })
        window.mediaStreamTrack && window.mediaStreamTrack.stop()
        if (pc) {
            for (const sender of senders) {
                pc.removeTrack(sender)
            }
        }
        camOpen = false
    }
    const negotiate = (pre) => {
        answer = null
        pre && pre()
        timers.offer = setInterval(() => {
            if (answer) {
                clearInterval(timers.offer)
                return
            }
            createOffer()
        }, 5000)
    }
    const createOffer = () => {
        if (!pc) return
        pc.createOffer(function (offer) {
            console.log('offer create success', offer)
            pc.setLocalDescription(new RTCSessionDescription(offer), () => {
                ws.send(JSON.stringify({
                    type: 'offer',
                    name: 'client1',
                    target: 'client2',
                    sdp: pc.localDescription
                }))
            });
        }, function (err) {
            console.log('offer create failed', err)
        }, {
            iceRestart: false,
            offerToReceiveAudio: false,
            offerToReceiveVideo: false
        })
    }
    const connectRemote = answer => {
        pc.setRemoteDescription(new RTCSessionDescription(answer), function () { }, () => { })
    }

    // Create WebSocket connection.
    const ws = new WebSocket('ws://localhost:9001');

    // Connection opened
    ws.addEventListener('open', function (event) {
        console.log('ws client connected')
        ws.send(JSON.stringify({ type: 'wsOpen' }))
    });
    // Listen for messages
    ws.addEventListener('message', function (event) {
        const obj = JSON.parse(event.data)
        console.log('Message from server ', obj)
        switch (obj.type) {
            case 'wsConnected':
                break
            case 'answer': {
                console.log('pc.signalingState', pc.signalingState)
                if (obj.name == 'client2' && obj.target == 'client1') {
                    answer = obj.answer
                    connectRemote(answer)
                }
                break
            }
            case 'reconnect': {
                answer = null
                createOffer()
                break
            }
            default:
                break
        }
    })

    // Helper functions
    function endCall() {
        var videos = document.getElementsByTagName("video");
        for (var i = 0; i < videos.length; i++) {
            videos[i].pause();
        }
        pc.close();
    }
    document.querySelector('#openCam').addEventListener('click', openCam)
    document.querySelector('#closeCam').addEventListener('click', closeCam)
    document.querySelector('#openRtc').addEventListener('click', openRtc)
    document.querySelector('#closeRtc').addEventListener('click', closeRtc)
</script>
<style>
    .right-tools {
        position: absolute;
        right: 0;
        top: 0;
        width: 100px;
        display: flex;
        flex-direction: column;
    }
</style>

</html>